# Libimage エンジン設計メモ

## 概要

Libimage は「自由（Liberty）×想像（Imagine）」を掲げる次世代メタバース／ゲームエンジン構想。  
個人情報とプライバシーを最重視し、誰でも遊べて作れる環境を目指す。

---

## 現在の到達点

### ✅ 実装済み

- OpenGLベースの3D描画  
- Part単位での立方体描画・移動  
- 簡易的な物理（AABB）  
- C++でのメインループ構築  

### ⚠️ 現在の課題

- ライティングが未実装（安っぽく見える）  
- AABB物理が粗く、リアリティが欠ける  
- モデルはCube集合のみでリグ構造がない  

---

## 今後の課題と方針

### 1. 物理層：GJK + EPA の導入

AABB の代替として **GJK（Gilbert–Johnson–Keerthi）アルゴリズム** を採用。  
さらに衝突後の「めり込み深さ」計算には **EPA (Expanding Polytope Algorithm)** を組み合わせる。

**目的:**
- 任意の凸形状同士の衝突判定
- 衝突法線・深さを取得して正確な反発処理を実現

**実装メモ:**
- 各Partに凸多面体メッシュを持たせる
- `CollisionResult { bool hit; Vec3 normal; float depth; }` のような構造体を返す

---

### 2. 描画層：シェーダによるライティング

現状の固定機能パイプラインを脱却し、**GLSL シェーダ**でライティングを実装する。

**段階的導入:**
1. Phong / Blinn-Phong ライティング  
2. PBR（物理ベースレンダリング）への拡張  

**目的:**
- 環境光・拡散光・鏡面反射を再現
- モデルの立体感と素材感を強化

---

### 3. モデル構造：R6リグ的な階層化

単なるCube集合ではなく、**リグ構造を持つキャラクターモデル**へ進化させる。

#### 基本構造例
Model
├─ Body (Root)
│   ├─ Head (Joint: Neck)
│   ├─ LeftArm (Joint: ShoulderL)
│   ├─ RightArm (Joint: ShoulderR)
│   ├─ LeftLeg (Joint: HipL)
│   └─ RightLeg (Joint: HipR)

**ポイント:**
- 各Partを剛体として扱い、Jointで接続
- Root Partが全体のTransformを統括
- 内部衝突は無視し、外部衝突のみをGJKで検出

---

### 4. アニメーション：Joint回転補間

各Jointに「目標角度」を与え、`lerp()` で補間。  
Luaスクリプトから `Humanoid:Move(Vector3)` のように操作可能にする。

**目的:**
- シンプルでも“キャラクター感”のある動作を実現
- 物理挙動と同期してリアルな動きを表現

---

### 5. 表現と物理の同期

見た目と当たり判定が一致しないと違和感が出る。  
→ GJKの法線ベクトルをライティングや影にも反映。  
→ RootTransformに基づいて描画・物理を一貫させる。

---

## 優先ロードマップ

| 段階 | 内容 | 目的 |
|------|------|------|
| Step 1 | GJK + EPA 実装 | 精密な衝突判定とリアリティの基礎 |
| Step 2 | Phongシェーダ導入 | 光と質感による立体感 |
| Step 3 | R6リグモデル構築 | キャラクターを定義 |
| Step 4 | Jointアニメーション | 動きの生命感を追加 |
| Step 5 | 物理と描画の同期 | “触れる”世界の完成 |

---

## 将来的な展望

- Lua サンドボックスの安全化（`io`, `os`, `debug`制限）  
- エディタでの Part 配置とLua編集  
- サーバー／Web クライアントによる共有・探索機能  
- AIによる自動モーション生成・学習キャラクター

---

**まとめ:**  
Libimage の次の目標は「動く世界」ではなく「**生きる世界**」を作ること。  
そのための三本柱は、  
- 正確な物理（GJK+EPA）  
- リアルな描画（シェーダ）  
- 意思を持つモデル（リグ＋Lua）  
である。